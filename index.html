<!DOCTYPE html>
<html>
    <body onhashchange="update(globalGames)">
        <h1><a href="/#">Blaseball Stream Panel</a></h1>
        <h2 id='date'></h2>
        <div id='main'>
        </div>
        <div id='game'>
        </div>
        <script>
            let globalGames = null;
            let history = [];

            function mainPageUpdateGame(game) {
                var element = document.getElementById(game.id);
                if (element) {
                    document.getElementById(game.id+'-lastUpdate').innerText = game.lastUpdate;
                } else { 
                    element = document.createElement('div');
                    element.setAttribute('id', game.id);
                    var teams = document.createElement('h3');
                    var link = document.createElement('a');
                    link.setAttribute('href', '#'+game.id);
                    link.innerText = game.awayTeamName + ' at ' + game.homeTeamName;
                    teams.setAttribute('id', game.id+'-teams');
                    teams.appendChild(link);
                    element.appendChild(teams);
                    
                    var score = document.createElement('p');
                    score.setAttribute('id', game.id+'-score');
                    score.innerText = game.awayTeamNickname + ' - ' + game.awayScore + ', ' + game.homeTeamNickname + ' - ' + game.homeScore;
                    element.appendChild(score);

                    var lastUpdate = document.createElement('p');
                    lastUpdate.setAttribute('id', game.id+'-lastUpdate');
                    lastUpdate.innerText = game.lastUpdate;
                    element.appendChild(lastUpdate);
                    
                    document.getElementById('main').appendChild(element);
                }
            }

            function update(games) {
                if (games.sim != null) {
                    document.getElementById('date').innerText = 
                        games.sim.subEraTitle + ': Season ' + games.sim.season + ', Day ' + games.sim.day + 1;
                }
                // main page
                if (location.hash.slice(1) == "") {
                    document.getElementById('game').innerHTML = "";
                    if (games.schedule != null) {
                        games.schedule.forEach(game => {
                            if (!game.gameComplete)
                                mainPageUpdateGame(game);
                        });
                        games.schedule.forEach(game => {
                            if (game.gameComplete)
                                mainPageUpdateGame(game);
                        });
                        document.getElementById('main').childNodes.forEach(node => {
                            if (games.schedule.filter(game => game.id == node.id).length == 0) {
                                node.remove();
                            }
                        });
                    }
                }
                else {  
                    document.getElementById('main').innerHTML = "";
                    let gameId = location.hash.slice(1);
                    var pEvent = document.createElement('p');
                    pEvent.innerText = games.schedule.filter(game => game.id == gameId)[0].lastUpdate;
                    if (document.getElementById('game').childNodes[0] == undefined) {
                        history.forEach(h => {
                        h.forEach(hi => {
                                if (hi.id == window.location.hash.substring(1)) {
                                    var prevEvent = document.createElement('p');
                                    prevEvent.innerText = hi.lastUpdate;
                                    if (document.getElementById('game').childNodes[0] == undefined
                                        || document.getElementById('game').childNodes[0].innerText != prevEvent.innerText) {
                                        document.getElementById('game').prepend(prevEvent);
                                    }
                                }
                            })
                        })
                    }
                    if (document.getElementById('game').childNodes[0] == undefined
                        || document.getElementById('game').childNodes[0].innerText != pEvent.innerText) {
                        document.getElementById('game').prepend(pEvent);
                    }
                }
            }

            let eventSource = new EventSource("https://cors-proxy.blaseball-reference.com/events/streamData");
            
            eventSource.onmessage = function(event) {
                let data = JSON.parse(event.data).value;
                let games = data.games;
                //console.log(games);
                globalGames = games;
                history.push(games.schedule);
                update(games);
            };
        </script>
    </body>
</html>